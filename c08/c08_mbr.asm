         ;?????çÀ8-1
         ;???????c08_mbr.asm
         ;???????????????????????????????? 
         ;?????????2011-5-5 18:17
         
         app_lba_start equ 100           ;??????????????????????????????
                                         ;?????????????????????
                                    
SECTION mbr align=16 vstart=0x7c00                                     

         ;???????¶ ????? 
         mov ax,0      
         mov ss,ax
         mov sp,ax
      
         mov ax,[cs:phy_base]            ;???????????????????????¶≈?? 
         mov dx,[cs:phy_base+0x02]
         mov bx,16        
         div bx            
         mov ds,ax                       ;??DS??ES?????????ß”???
         mov es,ax                        
    
         ;?????????????????? 
         xor di,di
         mov si,app_lba_start            ;???????????????????????? 
         xor bx,bx                       ;?????DS:0x0000?? 
         call read_hard_disk_0
      
         ;?????ßÿ??????????ßÿ??
         mov dx,[2]                      ;??????dxß’????ds??????????????? 
         mov ax,[0]
         mov bx,512                      ;512????????
         div bx
         cmp dx,0
         jnz @1                          ;¶ƒ????????????????????????1 
         dec ax                          ;??????????????????????????1 
   @1:
         cmp ax,0                        ;??????????ß≥?????512????????? 
         jz direct
         
         ;???????????
         push ds                         ;?????????????DS????? 

         mov cx,ax                       ;????????????????????
   @2:
         mov ax,ds
         add ax,0x20                     ;??????????512????????¶≈??
         mov ds,ax  
                              
         xor bx,bx                       ;??¶∆?????????????0x0000 
         inc si                          ;???????????? 
         call read_hard_disk_0
         loop @2                         ;????????????????????????? 

         pop ds                          ;???????¶À???????????????? 
      
         ;???????????¶À?? 
   direct:
         mov dx,[0x08]
         mov ax,[0x06]
         call calc_segment_base
         mov [0x06],ax                   ;??????????????????¶À?? 
      
         ;???????????¶À??
         mov cx,[0x0a]                   ;??????¶À?????????
         mov bx,0x0c                     ;???¶À??????
          
 realloc:
         mov dx,[bx+0x02]                ;32¶À??????16¶À 
         mov ax,[bx]
         call calc_segment_base
         mov [bx],ax                     ;????¶≈???
         add bx,4                        ;????????¶À??????4?????? 
         loop realloc 
      
         jmp far [0x04]                  ;???????????  
 
;-------------------------------------------------------------------------------
read_hard_disk_0:                        ;?????????????????
                                         ;????DI:SI=????????????
                                         ;      DS:BX=??????????
         push ax
         push bx
         push cx
         push dx
      
         mov dx,0x1f2
         mov al,1
         out dx,al                       ;???????????

         inc dx                          ;0x1f3
         mov ax,si
         out dx,al                       ;LBA???7~0

         inc dx                          ;0x1f4
         mov al,ah
         out dx,al                       ;LBA???15~8

         inc dx                          ;0x1f5
         mov ax,di
         out dx,al                       ;LBA???23~16

         inc dx                          ;0x1f6
         mov al,0xe0                     ;LBA28????????
         or al,ah                        ;LBA???27~24
         out dx,al

         inc dx                          ;0x1f7
         mov al,0x20                     ;??????
         out dx,al

  .waits:
         in al,dx
         and al,0x88
         cmp al,0x08
         jnz .waits                      ;???????????????????????? 

         mov cx,256                      ;?????????????
         mov dx,0x1f0
  .readw:
         in ax,dx
         mov [bx],ax
         add bx,2
         loop .readw

         pop dx
         pop cx
         pop bx
         pop ax
      
         ret

;-------------------------------------------------------------------------------
calc_segment_base:                       ;????16¶À?¶≈??
                                         ;????DX:AX=32¶À??????
                                         ;?????AX=16¶À?¶À???? 
         push dx                          
         
         add ax,[cs:phy_base]
         adc dx,[cs:phy_base+0x02]
         shr ax,4
         ror dx,4
         and dx,0xf000
         or ax,dx
         
         pop dx
         
         ret

;-------------------------------------------------------------------------------
         phy_base dd 0x10000             ;??????????????????????
         
 times 510-($-$$) db 0
                  db 0x55,0xaa